// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// 1. ì„¤ì • (Prisma 5.22.0 ê¸°ì¤€)
generator client {
  provider        = "prisma-client-js"
  // ğŸ‘‡ [ì¶”ê°€] PostgreSQL í™•ì¥ ê¸°ëŠ¥ í™œì„±í™” (Vector ì‚¬ìš©ì„ ìœ„í•´ í•„ìˆ˜)
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // ğŸ‘‡ [ì¶”ê°€] pgvector í™•ì¥ í™œì„±í™”
  extensions = [vector]
}

// ==========================================
// 1. ì‚¬ìš©ì ë° ì¸ì¦ (Auth & User Domain)
// ==========================================

enum Gender {
  MALE
  FEMALE
}

model User {
  // UUID (PK)
  id            String    @id @default(uuid()) @db.Uuid
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  birthDate     DateTime? @map("birth_date") @db.Date
  gender        Gender?
  createdAt     DateTime  @default(now()) @map("created_at")

  // ê´€ê³„ ì„¤ì • (Relations)
  accounts          Account[]
  sessions          Session[]
  userQueries       UserQuery[]
  medicalContext    UserMedicalContext[]
  bodyPartViews     BodyPartView[]
  bookmarkBodyParts BookmarkBodyPart[]
  bookmarkHospitals BookmarkHospital[]
  searchHistory     SearchHistory[]

  @@map("users")
}

// NextAuth ì†Œì…œ ë¡œê·¸ì¸ì„ ìœ„í•œ ê³„ì • í…Œì´ë¸”
model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ë³µí•© ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ (Constraint)
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth ì„¸ì…˜ ê´€ë¦¬ í…Œì´ë¸”
model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==========================================
// 2. ì‹ ì²´ ì •ë³´ (Body Domain)
// ==========================================

model BodySystem {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  nameKo      String  @map("name_ko")
  nameEn      String  @map("name_en")
  description String? @db.Text

  bodyParts BodyPart[]

  @@map("body_systems")
}

model BodyPart {
  id                Int     @id @default(autoincrement())
  systemId          Int     @map("system_id")
  code              String  @unique
  nameKo            String  @map("name_ko")
  nameEn            String  @map("name_en")
  description       String? @db.Text

  // JSON ë°ì´í„° íƒ€ì…
  keyRoles          Json?   @map("key_roles")
  observationPoints Json?   @map("observation_points")

  splineObjectId String? @map("spline_object_id")
  viewCamera     Json?   @map("view_camera")
  viewCount      Int     @default(0) @map("view_count")

  // ê´€ê³„ ì„¤ì •
  system        BodySystem         @relation(fields: [systemId], references: [id])
  diseases      Disease[]
  relatedAgents BodyPartAgent[]
  queries       UserQuery[]
  views         BodyPartView[]
  bookmarks     BookmarkBodyPart[]
  searchHistory SearchHistory[]

  @@map("body_parts")
}

model Disease {
  id                       Int     @id @default(autoincrement())
  bodyPartId               Int     @map("body_part_id")
  name                     String
  description              String? @db.Text
  commonSymptoms           String? @map("common_symptoms") @db.Text
  severityLevel            Int?    @map("severity_level") // 1~5
  requiresMedicalAttention Boolean @default(false) @map("requires_medical_attention")

  bodyPart BodyPart @relation(fields: [bodyPartId], references: [id])

  @@map("diseases")
}

// ==========================================
// 3. AI ì—ì´ì „íŠ¸ ë° ìƒë‹´ (AI Domain)
// ==========================================

model LlmAgent {
  id           Int     @id @default(autoincrement())
  name         String
  specialty    String?
  systemPrompt String? @map("system_prompt") @db.Text
  model        String?
  temperature  Float?
  maxTokens    Int?    @map("max_tokens")

  connectedBodyParts BodyPartAgent[]
  userQueries        UserQuery[]
  medicalContexts    UserMedicalContext[]

  @@map("llm_agents")
}

// BodyPart <-> LlmAgent ë‹¤ëŒ€ë‹¤ ì—°ê²° í…Œì´ë¸”
model BodyPartAgent {
  bodyPartId Int @map("body_part_id")
  agentId    Int @map("agent_id")

  bodyPart BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)
  agent    LlmAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@id([bodyPartId, agentId])
  @@map("body_part_agents")
}

model UserQuery {
  id              Int      @id @default(autoincrement())
  userId          String   @map("user_id") @db.Uuid
  bodyPartId      Int?     @map("body_part_id")
  agentId         Int?     @map("agent_id")
  question        String   @db.Text
  answer          String?  @db.Text
  confidenceScore Float?   @map("confidence_score")
  createdAt       DateTime @default(now()) @map("created_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyPart BodyPart? @relation(fields: [bodyPartId], references: [id])
  agent    LlmAgent? @relation(fields: [agentId], references: [id])

  @@map("user_queries")
}

// ì‚¬ìš©ìë³„ ì˜ë£Œ ì»¨í…ìŠ¤íŠ¸ (Userì™€ 1:1 ê´€ê³„)
model UserMedicalContext {
  id          Int      @id @default(autoincrement())
  userId      String   @map("user_id") @db.Uuid
  agentId     Int      @map("agent_id")

  summary     String   @db.Text // AI ìš”ì•½

  riskLevel   Int      @map("risk_level") // ìœ„í—˜ë„ (1~5)
  consultedAt DateTime @default(now()) @map("last_consulted_at")

  user  User     @relation(fields: [userId], references: [id])
  agent LlmAgent @relation(fields: [agentId], references: [id])

  // ğŸ‘‡ [ìˆ˜ì •] ì´ë¯¸ì§€ ì œëª©ì— ë§ì¶° ë‹¨ìˆ˜í˜•ìœ¼ë¡œ ë³€ê²½
  @@map("user_medical_context") 
}

// ==========================================
// 4. í™œë™ ë° ë¶ë§ˆí¬ (Activity Domain)
// ==========================================

model BodyPartView {
  id         Int      @id @default(autoincrement())
  userId     String   @map("user_id") @db.Uuid
  bodyPartId Int      @map("body_part_id")
  viewedAt   DateTime @default(now()) @map("viewed_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyPart BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)

  @@map("body_part_views")
}

model BookmarkBodyPart {
  id         Int      @id @default(autoincrement())
  userId     String   @map("user_id") @db.Uuid
  bodyPartId Int      @map("body_part_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyPart BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)

  @@map("bookmark_body_parts")
}

model BookmarkHospital {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid
  placeId   String   @map("place_id") // ì™¸ë¶€ ì§€ë„ API ID
  name      String
  address   String?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bookmark_hospitals")
}

model SearchHistory {
  id         Int      @id @default(autoincrement())

  // ì‚¬ìš©ì FK
  userId     String   @map("user_id") @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ë¶€ìœ„ FK
  bodyPartId Int      @map("body_part_id")
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)

  // ì¡°íšŒ ì‹œê°
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("search_history")
}

model MedicalKnowledge {
  id        Int      @id @default(autoincrement())
  category  String   // ì˜ˆ: "ë‘í†µ", "ë³µí†µ", "ì‹¬í˜ˆê´€"
  
  // ğŸ‘‡ [ìˆ˜ì •] ê¸´ í…ìŠ¤íŠ¸ ì €ì¥ì„ ìœ„í•´ @db.Text ì¶”ê°€
  content   String   @db.Text 

  // ë²¡í„° ë°ì´í„° (Gemini Embeddingì€ 768ì°¨ì›)
  embedding Unsupported("vector(768)")?

  // ğŸ‘‡ [ê¶Œì¥] DB ì»¬ëŸ¼ëª…ì„ ë‹¤ë¥¸ í…Œì´ë¸”ê³¼ í†µì¼ì„± ìˆê²Œ snake_caseë¡œ ë§¤í•‘
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("medical_knowledge")
}